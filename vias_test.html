<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title> VIAS test </title>
<script src="vias.js"></script>
<style>
.btn {
  width:120px;
}
</style>
</head>

<body>

<button type="button" class="btn" id="idBtnConnect">Connect</button><br>
<button type="button" class="btn" id="idBtnDisconnect">Disconnect</button><br>
<button type="button" class="btn" id="idBtnGet">Get</button><br>
<button type="button" class="btn" id="idBtnSubscribe">Subscribe</button><br>
<button type="button" class="btn" id="idBtnUnsubscribe">Unsubscribe</button><br>


</body>
<script>
var VSS_SPEED = 'Signal.Drivetrain.Transmission.Speed';
var VISS_IP = 'wwwivi';
var VISS_PORT='3000';
const viscOption = {
  'host': VISS_IP,
  'protocol': 'ws://',
  'port': VISS_PORT
};

var subscription = null;
var vias = new VISClient( viscOption );
var bConnected = false;

const connectCb = () => {
  console.log(`Connect: Success`);
  bConnected = true;
};
const connectErrCb = (_err) => {
  console.error(`Connect: Error : ${_err.number}`);
  bConnected = false;
};
const disconnectCb = () => {
  console.log(`Disconnect: Success`);
  bConnected = false;
};
const disconnectErrCb = (_err) => {
  console.error(`Disconnect: Error : ${_err.number}`);
  //bConnected = false; // don't change
};

function doConnect() {

  if (bConnected) {
    console.log("WebSocket already connected");
    return;
  }
  vias.connect(connectCb, connectErrCb);
}

function doDisconnect() {
   if (!bConnected) {
    console.log("WebSocket not connected");
    return;
  }
  vias.disconnect(disconnectCb, disconnectErrCb);
}

function doGet() {

  if (!bConnected) {
    console.log("WebSocket not connected");
    return;
  }
  // get method test
  vias.get(VSS_SPEED,
    function(_val) {
      console.log(`get:success: val= ${_val}`);
    },
    function(_err) {
      console.error(`get:failure: err= ${_err.number}`);
    });
}

function doSubscribe() {
  if (!bConnected) {
    console.log("WebSocket not connected");
    return;
  }

  subscription = vias.subscribe(VSS_SPEED,
    function(_val) {
      console.log(`subscribe:success: val= ${_val}`);
    },
    function(_err) {
      console.error(`subscribe:failure: err= ${_err.number}`);
    });

}

function doUnsubscribe() {
  if (!bConnected) {
    console.log("WebSocket not connected");
    return;
  }

  if (subscription) {
    vias.unsubscribe(subscription,
      () => {
        console.log(`unsubscribe:success`);
        subscription = null;
      },
      (_err) => {
        console.error(`unsubscribe:failure err=${_err.number}`);
      });
  }
}

(function() {
  document.getElementById('idBtnConnect').addEventListener('click', doConnect);
  document.getElementById('idBtnDisconnect').addEventListener('click', doDisconnect);
  document.getElementById('idBtnGet').addEventListener('click', doGet);
  document.getElementById('idBtnSubscribe').addEventListener('click', doSubscribe);
  document.getElementById('idBtnUnsubscribe').addEventListener('click', doUnsubscribe);
})();

</script>
</html>
