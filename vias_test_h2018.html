<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title> VIAS test </title>
<script src="vias_h2018.js"></script>
<script src="svr_config.js"></script>
<script src="test_util.js"></script>
<style>

body{
  width:1920px;
  margin:10px;
  margin-left:100px;
}
#header{
  width:1920px;
  margin:5px;
}
#wrapper{
  float:left;
}
#main{
  width:300px;
  float:left;
}
#right{
  width:1200px;
  float:right;
}
#msg { height:600px; width:1200px; background-color:lightgrey; font-size:14px;}

.btn {
  width:180px;
}
#idSpanDoorlock {
  font-size:14px;
}
</style>
</head>

<body>
<header>
  roomID: <input type='text' id='roomid' value='0100'></input>
</header>

<div id='wrapper'>
  <main id='main'>
    <button type="button" class="btn" id="idBtnConnect">Connect</button><br>
    <button type="button" class="btn" id="idBtnDisconnect">Disconnect</button><br>
    <br>
    <button type="button" class="btn" id="idBtnGetSpeed">Get Speed</button><br>
    <br>
    <button type="button" class="btn" id="idBtnSubscribeSpeed">Subscribe Speed</button><br>
    <button type="button" class="btn" id="idBtnUnsubscribeSpeed">Unsubscribe Speed</button><br>
    <br>
    <button type="button" class="btn" id="idBtnSubscribeRPM">Subscribe RPM</button><br>
    <button type="button" class="btn" id="idBtnUnsubscribeRPM">Unsubscribe RPM</button><br>
    <br>
    <button type="button" class="btn" id="idBtnUnsubscribeAll">UnsubscribeAll</button><br>
    <br>
    <button type="button" class="btn" id="idBtnSetDoorlockTrue">Set Doorlock True</button><br>
    <button type="button" class="btn" id="idBtnSetDoorlockFalse">Set Doorlock False</button><br>
    <button type="button" class="btn" id="idBtnGetDoorlock">Get Doorlock</button><br>
    <span id="idSpanDoorlock" >* Doorlock = Row2 Right Door's lock</span>
    <br>
    <button type="button" class="btn" id="idBtnAuthorize">Authorize</button><br>
    <button type="button" class="btn" id="idBtnGetVss">getVss</button><br>
    <br>
    <!-- Promise test -->
    === Promise Test ===
    <br>
    <button type="button" class="btn" id="idBtnPromiseConnect">Connect</button><br>
    <button type="button" class="btn" id="idBtnPromiseDisconnect">Disconnect</button><br>
    <br>
    <button type="button" class="btn" id="idBtnPromiseGetSpeed">Get Speed</button><br>
    <button type="button" class="btn" id="idBtnMultiPromiseGet">Multi Get<br>(Speed, RPM, Steer)</button><br>
    <button type="button" class="btn" id="idBtnPromiseUnsubscribeSpeed">Unsubscribe Speed</button><br>
    <button type="button" class="btn" id="idBtnPromiseUnsubscribeAll">UnsubscribeAll</button><br>
    <button type="button" class="btn" id="idBtnPromiseSetDoorlockTrue">Set</button><br>
    <button type="button" class="btn" id="idBtnPromiseAuthorize">Authorize</button><br>
    <button type="button" class="btn" id="idBtnPromiseGetVss">getVss</button><br>

  </main>

  <div id='right'>
    <button onclick="clearMsgArea();">clearMsgArea</button>
    <textarea id='msg'>
    </textarea>
  </div>
</div>

</body>
<script>
var VSS_SPEED    = 'Signal.Drivetrain.Transmission.Speed';
var VSS_RPM      = 'Signal.Drivetrain.InternalCombustionEngine.RPM';
var VSS_STEER    = 'Signal.Chassis.SteeringWheel.Angle';
var VSS_DOORLOCK = 'Signal.Cabin.Door.Row1.Right.IsLocked';
//var VSS_DOORLOCK = 'Signal.Cabin.Door.Row2.Right.IsLocked';

//var VISS_IP = 'wwwivi';
//var VISS_PORT='3000';
const viscOption = {
  'host': VISS_IP
  ,'protocol': 'ws://'
  ,'port': VISS_PORT
  ,'roomId': undefined
};

var subId_speed = null;
var subId_RPM = null;

var vias = undefined;
var bConnected = false;

const connectCb = () => {
  showInMsgArea(`Connect: Success`);
  bConnected = true;
};
const connectErrCb = (_err) => {
  showInMsgArea('Connect: Error :' + _err.number );
  bConnected = false;
};
// TODO: errorの返し方はどうする？
// このcallback は定義上は引数なし。
// disconnect 成功時のcallback. err というよりは msg を返したい
const disconnectCb = (_msg) => {
  showInMsgArea(`Disconnect: Success` + _msg);
  bConnected = false;
  vias = undefined;
};
const disconnectErrCb = (_err) => {
  showInMsgArea(`Disconnect: Error : ${_err.number}`);
};

function doConnect() {
  if (vias !== undefined || bConnected) {
    showInMsgArea("WebSocket already connected");
    return;
  }
  viscOption.roomId = document.getElementById('roomid').value;
  vias = new VISClient( viscOption );
  vias.connect(connectCb, connectErrCb);
}
function doPromiseConnect() {
  if (vias !== undefined || bConnected) {
    showInMsgArea("WebSocket already connected");
    return;
  }
  viscOption.roomId = document.getElementById('roomid').value;
  vias = new VISClient( viscOption );
  vias.connect().then( ()=>{
    connectCb();
  }, (_err) => {
    connectErrCb(_err);
  });
}

function doDisconnect() {
   if (vias === undefined || !bConnected) {
    showInMsgArea("WebSocket not connected");
    return;
  }
  vias.disconnect(disconnectCb, disconnectErrCb);
}
function doPromiseDisconnect() {
   if (vias === undefined || !bConnected) {
    showInMsgArea("WebSocket not connected");
    return;
  }
  vias.disconnect().then(()=>{
    disconnectCb();
  }, (_err)=>{
    disconnectErrCb(_err);
  });
}

function doGetSpeed() {

  if (!bConnected) {
    showInMsgArea("WebSocket not connected");
    return;
  }
  // get method test
  showInMsgArea("Get Speed");
  vias.get(VSS_SPEED,
    function(_val) {
      showInMsgArea(`get speed:success: val= ${_val}`);
    },
    function(_err) {
      showInMsgArea(`get speed:failure: err= ${_err.number}`);
    });
}
function doPromiseGetSpeed() {

  if (!bConnected) {
    console.log("WebSocket not connected");
    return;
  }
  // promise type get method test
  vias.get(VSS_SPEED).then((_val) => {
    showInMsgArea(`Promise get speed:success: val= ${_val}`);
  },(_err) => {
    showInMsgArea(`Promise get speed:failure: err= ${_err.number}`);
  });
}
function doMultiPromiseGet() {

  if (!bConnected) {
    console.log("WebSocket not connected");
    return;
  }
  // promise type get method test
  vias.get(VSS_SPEED).then((_val) => {
    showInMsgArea(`Promise get speed:success: val= ${_val}`);
    return vias.get(VSS_RPM);
  }).then((_val) => {
    showInMsgArea(`Promise get RPM:success: val= ${_val}`);
    return vias.get(VSS_STEER);
  }).then((_val) => {
    showInMsgArea(`Promise get SteeringAngle:success: val= ${_val}`);
  }).catch((_err) => {
    showInMsgArea(`Error: ${_err.number}`);
  });
}

function doSubscribe(_refval) {
  if (!bConnected) {
    showInMsgArea("WebSocket not connected");
    return;
  }
  showInMsgArea("Subscribe " + _refval.path);
  _refval.subId = vias.subscribe(_refval.path, _refval.sucCb, _refval.errCb);
}
function doSubscribeSpeed() {
  var refval = {};
  refval.path = VSS_SPEED;
  refval.subId = subId_speed;
  refval.sucCb = function(_val) {
    showInMsgArea(`subscribe speed: success: val= ${_val}`);
  };
  refval.errCb = function(_err) {
    showInMsgArea(`subscribe speed: failure: err= ${_err.number}`);
  };

  doSubscribe(refval);
  subId_speed = refval.subId;
}
function doSubscribeRPM() {
  var refval = {};
  refval.path = VSS_RPM;
  refval.subId = subId_RPM;
  refval.sucCb = function(_val) { showInMsgArea(`subscribe RPM: success: val= ${_val}`); };
  refval.errCb = function(_err) { showInMsgArea(`subscribe RPM: failure: err= ${_err.number}`); };

  doSubscribe(refval);
  subId_RPM = refval.subId;
}

function doUnsubscribe(_refval) {
  if (!bConnected) {
    showInMsgArea("WebSocket not connected");
    return;
  }

  if (_refval.subId) {
    vias.unsubscribe(_refval.subId,
      _refval.sucCb, _refval.errCb);
  }
}

function doUnsubscribeSpeed() {
  var refval = {};
  refval.subId = subId_speed;
  refval.sucCb = function() {
    showInMsgArea('unsubscribe:success');
    subId_speed = null;
  };
  refval.errCb = function(_err) {
    showInMsgArea(`unsubscribe:failure err=${_err.number}`);
  };
  doUnsubscribe(refval);
}
function doPromiseUnsubscribeSpeed() {
  if (!bConnected) {
    showInMsgArea("WebSocket not connected");
    return;
  }
  if (subId_speed === null || subId_speed === undefined) {
    showInMsgArea("Speed is not subscribed");
    return;
  }
  vias.unsubscribe(subId_speed).then(()=>{
    showInMsgArea('Promise unsubscribe:success');
    subId_speed = null;
  }, (_err)=>{
    showInMsgArea(`Promise unsubscribe:failure err=${_err.number}`);
  });
}

function doUnsubscribeRPM() {
  var refval = {};
  refval.subId = subId_RPM;
  refval.sucCb = function() {
    showInMsgArea('unsubscribe:success');
    subId_RPM = null;
  };
  refval.errCb = function(_err) {
    showInMsgArea(`unsubscribe:failure err=${_err.number}`);
  };
  doUnsubscribe(refval);
}

function doUnsubscribeAll() {
  if (!bConnected) {
    showInMsgArea("WebSocket not connected");
    return;
  }

  vias.unsubscribeAll(
    function() {
      showInMsgArea('unsubscribeAll:success');
    },
    function(_err) {
      showInMsgArea(`unsubscribeAll:failure err=${_err.number}`);
    }
  );
}
function doPromiseUnsubscribeAll() {
  if (!bConnected) {
    showInMsgArea("WebSocket not connected");
    return;
  }
  vias.unsubscribeAll().then( ()=>{
    showInMsgArea('Promise unsubscribeAll:success');
  }, (_err)=> {
    showInMsgArea(`Promise unsubscribeAll:failure err=${_err.number}`);
  });
}

function doGetDoorlock() {
  if (!bConnected) {
    showInMsgArea("WebSocket not connected");
    return;
  }
  showInMsgArea("Get Doorlock");
  // get method test
  vias.get(VSS_DOORLOCK,
    function(_val) {
      showInMsgArea(`get doorlock:success: val= ${_val}`);
    },
    function(_err) {
      showInMsgArea(`get doorlock:failure: err= ${_err.number}`);
    });
}
function doSetDoorlockTrue() {
  if (!bConnected) {
    showInMsgArea("WebSocket not connected");
    return;
  }
  // set method test
  vias.set(VSS_DOORLOCK, 'true',
    function() {
      showInMsgArea(`set doorlock:success`);
    },
    function(_err) {
      showInMsgArea(`set doorlock:failure: err= ${_err.number}`);
    });
}
function doPromiseSetDoorlockTrue() {
  if (!bConnected) {
    showInMsgArea("WebSocket not connected");
    return;
  }
  // set method test
  vias.set(VSS_DOORLOCK, 'true').then(()=>{
    showInMsgArea(`Promise set doorlock:success`);
  },(_err)=>{
    showInMsgArea(`Promise set doorlock:failure: err= ${_err.number}`);
  });
}

function doSetDoorlockFalse() {
  if (!bConnected) {
    showInMsgArea("WebSocket not connected");
    return;
  }
  // set method test
  vias.set(VSS_DOORLOCK, 'false',
    function() {
      showInMsgArea(`set doorlock:success`);
    },
    function(_err) {
      showInMsgArea(`set doorlock:failure: err= ${_err.number}`);
    });
}
function doAuthorize() {
  if (!bConnected) {
    showInMsgArea("WebSocket not connected");
    return;
  }
  // get method test
  var userToken = 'token_valid';    // fake token for test
  var deviceToken = 'token_valid';  // fake token for test
  var tokens = {"authorization"     : userToken,
                "www-vehicle-device": deviceToken};
  vias.authorize(tokens,
    function(_ttl) {
      showInMsgArea(`authorize :success: TTL= ${_ttl}`);
    },
    function(_err) {
      showInMsgArea(`authorize :failure: err= ${_err.number}`);
    });
}
function doPromiseAuthorize() {
  if (!bConnected) {
    showInMsgArea("WebSocket not connected");
    return;
  }
  // get method test
  var userToken = 'token_valid';    // fake token for test
  var deviceToken = 'token_valid';  // fake token for test
  var tokens = {"authorization"     : userToken,
                "www-vehicle-device": deviceToken};
  vias.authorize(tokens).then((_ttl)=>{
    showInMsgArea(`Promise authorize :success: TTL= ${_ttl}`);
  },(_err)=>{
    showInMsgArea(`Promise authorize :failure: err= ${_err.number}`);

  });
}

function doGetVss() {
  if (!bConnected) {
    showInMsgArea("WebSocket not connected");
    return;
  }
  // get method test
  var path = 'Attribute.Body';
  showInMsgArea('getVSS: path=' + path);
  vias.getVss(path,
    function(_vss) {
      showInMsgArea(`getVSS :success: vss= ${_vss}`);
    },
    function(_err) {
      showInMsgArea(`getVSS :failure: err= ${_err.number}`);
    });
}
function doPromiseGetVss() {
  if (!bConnected) {
    showInMsgArea("WebSocket not connected");
    return;
  }
  // get method test
  var path = 'Attribute.Body';
  showInMsgArea('Promise getVSS: path=' + path);
  vias.getVss(path).then(()=>{
    showInMsgArea(`Promise getVSS :success: vss= ${_vss}`);
  }, (_err)=>{
    showInMsgArea(`Promise getVSS :failure: err= ${_err.number}`);
  });
}

(function() {
  document.getElementById('idBtnConnect').addEventListener('click', doConnect);
  document.getElementById('idBtnDisconnect').addEventListener('click', doDisconnect);

  document.getElementById('idBtnGetSpeed').addEventListener('click', doGetSpeed);

  document.getElementById('idBtnSubscribeSpeed').addEventListener('click', doSubscribeSpeed);
  document.getElementById('idBtnUnsubscribeSpeed').addEventListener('click', doUnsubscribeSpeed);
  document.getElementById('idBtnSubscribeRPM').addEventListener('click', doSubscribeRPM);

  document.getElementById('idBtnUnsubscribeRPM').addEventListener('click', doUnsubscribeRPM);
  document.getElementById('idBtnUnsubscribeAll').addEventListener('click', doUnsubscribeAll);

  document.getElementById('idBtnSetDoorlockTrue').addEventListener('click', doSetDoorlockTrue);
  document.getElementById('idBtnSetDoorlockFalse').addEventListener('click', doSetDoorlockFalse);
  document.getElementById('idBtnGetDoorlock').addEventListener('click', doGetDoorlock);

  document.getElementById('idBtnAuthorize').addEventListener('click', doAuthorize);
  document.getElementById('idBtnGetVss').addEventListener('click', doGetVss);

  // == Promise test ==
  document.getElementById('idBtnPromiseConnect').addEventListener('click', doPromiseConnect);
  document.getElementById('idBtnPromiseDisconnect').addEventListener('click', doPromiseDisconnect);

  document.getElementById('idBtnPromiseGetSpeed').addEventListener('click', doPromiseGetSpeed);
  document.getElementById('idBtnMultiPromiseGet').addEventListener('click', doMultiPromiseGet);

  document.getElementById('idBtnPromiseUnsubscribeSpeed').addEventListener('click', doPromiseUnsubscribeSpeed );
  document.getElementById('idBtnPromiseUnsubscribeAll').addEventListener('click', doPromiseUnsubscribeAll );

  document.getElementById('idBtnPromiseSetDoorlockTrue').addEventListener('click', doPromiseSetDoorlockTrue );
  document.getElementById('idBtnPromiseAuthorize').addEventListener('click', doPromiseAuthorize );
  document.getElementById('idBtnPromiseGetVss').addEventListener('click', doPromiseGetVss );
})();

</script>
</html>
